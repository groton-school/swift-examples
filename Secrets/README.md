#  Secrets

Absolutely, positively never-ever store secrets hard-coded in your source. And don't commit them to your repository, either.

## Setup

1. Close the project in Xcode (we're about to perform surgery on it -- better that it's not awake!)
2. In the Terminal, `cd` to the project directory
3. `bundle install` (installs the Ruby gems for `cocoapods-keys`, if not already installed -- likely need to take a look at [Troubleshooting](#Troubleshooting) when this almost definitely fails)
3. `pod install` (installs the pods for `cocoapods-keys` and enter secrets as asked)
3. `open Secrets.xcworkspace` (now that Cocoapods is installed, we _only_ want to open the workspace, **not** the project)

## Troubleshooting

### `bundle install` fails

If you are using the macOS default install of Ruby, things may not work early on. Go ahead and install the Homebrew version of Ruby instead.

- [Install Homebrew](https://brew.sh/) (You should have this in general)
- `brew install ruby`

Cocoapods blithely suggests that you install it using `sudo`. This is a terrible suggestion -- you don't want to install software as root! Instead, fix the permissions that are blocking it.

``` bash
ls -hal /opt/homebrew/lib/ruby
```

This will give you a directory listing of the Homebrew Ruby install:

```
total 0
drwxr-xr-x    5 sbattis  admin   160B Mar 20 15:27 .
drwxrwxr-x  528 sbattis  admin    17K Mar 18 08:21 ..
drwxr-xr-x    3 sbattis  admin    96B Feb 22 10:43 gems
drwxr-xr-x@   3 sbattis  admin    96B Mar 19 14:23 site_ruby
drwxr-xr-x    3 sbattis  admin    96B Mar 20 15:27 vendor_ruby
```

The user (`sbattis`) and group (`admin`) are listed next to each subdirectory. The core problem is that somewhere in `gems`, a directory is owned by `root`, when it should be owned by _you_. Fix it (user your username in place of mine)!

```bash
sudo chown -R sbattis /opt/homebrew/lib/ruby/gems
```

### Build fails

```
    SDK does not contain 'libarclite' at the path '/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/arc/libarclite_iphonesimulator.a'; try increasing the minimum deployment target
```

1. In the `Pods` Project, in the `Keys-framework` target, under `Build Settings`, set `iOS Deployment Target` to `17.0` (the default value of `8.0` is not recent enough -- it needs to be _at least_ `12.0`)
2. In the `Secrets` Project, in the `Secrets` target, under `Build Settings`, set `User Script Sandboxing` to `No` (The obfusticated code generated by `cocoapods-keys` seems not to be generated properly in sandboxed mode -- which underscores that it is an abandoned and outdated project... but has no real replacement.)

## References

- [Secret Management on iOS](https://nshipster.com/secrets), Matt
- [Cocoapods](https://cocoapods.org/)
- [`cocoapods-keys`](https://github.com/orta/cocoapods-keys?tab=readme-ov-file#readme)

